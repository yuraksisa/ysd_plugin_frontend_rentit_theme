<script type="text/javascript">

require(['jquery', 'YSDRemoteDataSource','YSDSelectSelector',
	     'jquery.validate', 'jquery.ui', 'jquery.ui.datepicker-es', 
	     'jquery.ui.datepicker.validation', 'datejs',
	     'bootstrap', 'bootstrap.select'], 
	     function($, RemoteDataSource, SelectSelector) {

  selectorModel = {
      requestLanguage: <% if locale=locale_to_translate_into %>'<%=locale%>'<%else%>null<%end%>,
      minDays   : <%=booking_min_days%>,
  };

  selectorController = {

      dateFromChanged: function() {

        var dateFrom = $('#date_from').datepicker('getDate');
        var dateTo = $('#date_from').datepicker('getDate');
        <% if booking_item_family.cycle_of_24_hours %>
        dateTo.setDate(dateFrom.getDate() + selectorModel.minDays);
        <% else %>
          dateTo.setDate(dateFrom.getDate() + (selectorModel.minDays - 1));
        <% end %>

        $('#date_to').datepicker('setDate', dateTo );
        $('#date_to').datepicker('option', 'minDate', dateTo);

      },
      formSearchClick: function() {
        <% if booking_item_family.driver and driver_age_rules and driver_age_rule_definition and !driver_age_rule_definition.driver_age_rules.empty?  %>
        if ($('#driver_age_rule option:selected').attr('allowed') == 'false') {
            alert($('#driver_age_rule option:selected').attr('not-allowed-message'));
            return;
        }
        <% end %>
        $('#formSearchSubmit')[0].form.submit();
      }


  };

  selectorView = {

  	init: function() {

  		this.setupForm();
  	  this.setupDateControls();
  		this.loadPickupReturnPlaces();
  		this.loadPickupReturnTime();

  	},

    setupForm: function() {
  	  $('#formSearchSubmit').bind('click', function(){
  	      selectorController.formSearchClick();
      })
    },

  	setupDateControls: function() {
      
      $.datepicker.setDefaults( $.datepicker.regional["<%=session[:locale] || 'es'%>" ] );
      var locale = $.datepicker.regional["<%=session[:locale] || 'es'%>"];

      $('#date_from').datepicker({numberOfMonths:1, 
          minDate: new Date(), 
          maxDate: new Date().add(365).days(), 
          dateFormat: 'dd/mm/yy',
          firstDay: 1}, 
          locale);
      $('#date_from').datepicker('setDate', '+0'); 

      $('#date_to').datepicker({numberOfMonths:1, 
          minDate: <% if booking_item_family.cycle_of_24_hours %>new Date().add(selectorModel.minDays).days()<%else%>new Date().add(selectorModel.minDays-1).days()<%end%>,
          maxDate: new Date().add(365).days(),
          dateFormat: 'dd/mm/yy'}, locale);
      $('#date_to').datepicker('setDate', <% if booking_item_family.cycle_of_24_hours %>'+'+selectorModel.minDays<%else%>'+'+(selectorModel.minDays-1)<%end%>);

      $('#date_from').bind('change', function() {
           selectorController.dateFromChanged();
         });

  	},

  	loadPickupReturnPlaces: function() {

  	    var pickupPlacesURL = '/api/booking/frontend/pickup-places';
  	    if (selectorModel.requestLanguage != null) {
  	      pickupPlacesURL += '?lang='+selectorModel.requestLanguage;
        }

        var dataSourcePickupPlaces = new RemoteDataSource(pickupPlacesURL,
																													{'id':'name','description':'name'});
        var pickupPlace = new SelectSelector('pickup_place', 
        		dataSourcePickupPlaces, null, false, '',
                function() { 
                	$('#pickup_place').selectpicker();
                  $('#pickup_place').selectpicker('refresh');
                } );

        var returnPlacesURL = '/api/booking/frontend/return-places';
        if (selectorModel.requestLanguage != null) {
            returnPlacesURL += '?lang='+selectorModel.requestLanguage;
        }

        var dataSourceReturnPlaces = new RemoteDataSource(returnPlacesURL,
																													{'id':'name','description':'name'});
        var returnPlace = new SelectSelector('return_place', 
        		dataSourcePickupPlaces, null, false, '',
                function() { 
                	$('#return_place').selectpicker();
                	$('#return_place').selectpicker('refresh');
                } );          

  	},

  	loadPickupReturnTime: function() {

        var dataSourcePickupReturnTime = new RemoteDataSource('/api/booking/frontend/pickup-return-times',
																						{
        	  																	id: function(data){return data;},
																							description: function(data){return data;}
																						});

        var pickupTime = new SelectSelector('time_from', 
        		dataSourcePickupReturnTime, '10:00', false, '',
                function() { 
                	$('#time_from').selectpicker();
					        $('#time_from').val('10:00');
					        $('#time_from').selectpicker('refresh');
                } );             
        var returnTime = new SelectSelector('time_to', 
        		dataSourcePickupReturnTime, '10:00', false, '',
                function() { 
                	$('#time_to').selectpicker();
					$('#time_to').val('10:00');
					$('#time_to').selectpicker('refresh');                	 
                } );  

  	}

  };

  selectorView.init();

});

</script>
