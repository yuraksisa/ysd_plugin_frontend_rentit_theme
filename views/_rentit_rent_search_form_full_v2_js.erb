<script type="text/javascript">

require(['jquery', 'YSDRemoteDataSource','YSDSelectSelector',
	     'jquery.validate', 'jquery.ui', 'jquery.ui.datepicker-es',
       'jquery.ui.datepicker-en','jquery.ui.datepicker-it','jquery.ui.datepicker-ca',
	     'jquery.ui.datepicker.validation', 'datejs',
	     'bootstrap', 'bootstrap.select'], 
	     function($, RemoteDataSource, SelectSelector) {

  selectorModel = {
      requestLanguage: <% if locale=locale_to_translate_into %>'<%=locale%>'<%else%>null<%end%>,
      minDays   : <%=booking_min_days%>,
      allowCustomPlaces : <%=pickup_return_places_configuration == 'list+custom'%>,
      pickupReturnPlaces: <%if booking_item_family.pickup_return_place%>true<%else%>false<%end%>,
      timeToFrom: <%if booking_item_family.time_to_from%>true<%else%>false<%end%>
  };

  selectorController = {

      dateFromChanged: function() {

        var dateFrom = $('#date_from').datepicker('getDate');
        var dateTo = $('#date_from').datepicker('getDate');
        <% if booking_item_family.cycle_of_24_hours %>
        dateTo.setDate(dateFrom.getDate() + selectorModel.minDays);
        <% else %>
          dateTo.setDate(dateFrom.getDate() + (selectorModel.minDays - 1));
        <% end %>

        $('#date_to').datepicker('setDate', dateTo );
        $('#date_to').datepicker('option', 'minDate', dateTo);

      },

      pickupPlaceChanged: function() {

         if (selectorModel.allowCustomPlaces) {
             if ($('#pickup_place').val() == 'other') {
                 $('input[name=custom_pickup_place]').val('true');
                 $('#another_pickup_place_group').show();
             }
             else {
                 $('input[name=custom_pickup_place]').val('false');
                 $('#another_pickup_place_group').hide();
             }
         }

      },

      returnPlaceChanged: function() {

          if (selectorModel.allowCustomPlaces) {
              if ($('#return_place').val() == 'other') {
                  $('input[name=custom_return_place]').val('true');
                  $('#another_return_place_group').show();
              }
              else {
                  $('input[name=custom_return_place]').val('false');
                  $('#another_return_place_group').hide();
              }
          }

      },

      formSearchClick: function() {
        <% if booking_item_family.driver and driver_age_rules and driver_age_rule_definition and !driver_age_rule_definition.driver_age_rules.empty?  %>
        if ($('#driver_age_rule option:selected').attr('allowed') == 'false') {
            alert($('#driver_age_rule option:selected').attr('not-allowed-message'));
            return;
        }
        <% end %>
        $('#formSearchSubmit')[0].form.submit();
      }


  };

  selectorView = {

  	init: function() {

  		this.setupForm();
  		this.setupValidation();
  	  this.setupDateControls();
  	  if (selectorModel.pickupReturnPlaces) {
          this.loadPickupReturnPlaces();
      }
      if (selectorModel.timeToFrom) {
          this.loadPickupReturnTime();
      }

  	},

    setupValidation: function() {

  	    $('form[name=search_form]').validate({
           rules: {
               promotion_code: {
                   remote: {
                       url: '/api/check-promotion-code',
                       type: 'post',
                       data: {
                           code: function() {
                               return $('#promotion_code').val();
                           }
                       }
                   }
               }
           },
           messages: {
               promotion_code: {
                   remote: "<%=t.front_end_reservation.promotion_code_not_valid%>"
               }
           },
           errorClass : 'text-danger'
        });

    },

    setupForm: function() {
  	  $('#formSearchSubmit').bind('click', function(){
  	      if ($('form[name=search_form]').valid())
          {
              selectorController.formSearchClick();
          }
      })
    },

  	setupDateControls: function() {
      
      $.datepicker.setDefaults( $.datepicker.regional["<%=session[:locale] || 'es'%>"] );
      var locale = $.datepicker.regional["<%=session[:locale] || 'es'%>"];

      $('#date_from').datepicker({numberOfMonths:1, 
          minDate: new Date(), 
          maxDate: new Date().add(365).days(), 
          dateFormat: 'dd/mm/yy'},
          locale);
      $('#date_from').datepicker('setDate', '+0'); 

      $('#date_to').datepicker({numberOfMonths:1, 
          minDate: <% if booking_item_family.cycle_of_24_hours %>new Date().add(selectorModel.minDays).days()<%else%>new Date().add(selectorModel.minDays-1).days()<%end%>,
          maxDate: new Date().add(365).days(),
          dateFormat: 'dd/mm/yy'}, locale);
      $('#date_to').datepicker('setDate', <% if booking_item_family.cycle_of_24_hours %>'+'+selectorModel.minDays<%else%>'+'+(selectorModel.minDays-1)<%end%>);

      $('#date_from').bind('change', function() {
           selectorController.dateFromChanged();
         });

  	},

  	loadPickupReturnPlaces: function() {

  	    var pickupPlacesURL = '/api/booking/frontend/pickup-places';
  	    if (selectorModel.requestLanguage != null) {
  	      pickupPlacesURL += '?lang='+selectorModel.requestLanguage;
        }

        var dataSourcePickupPlaces = new RemoteDataSource(pickupPlacesURL,
																													{'id':'id','description':'name'});
        var pickupPlace = new SelectSelector('pickup_place', 
        		dataSourcePickupPlaces, null, false, '',
                function() {
                  if (selectorModel.allowCustomPlaces) {
                      $('#pickup_place').append($('<option>', {
                          value: 'other',
                          text : '<%=t.front_end_reservation.another_place%>'
                      }));
                  }
                	$('#pickup_place').selectpicker();
                  $('#pickup_place').selectpicker('refresh');
                } );

        if (selectorModel.allowCustomPlaces) {
            $('#pickup_place').bind('change', function() {
               selectorController.pickupPlaceChanged();
            });
        }


        var returnPlacesURL = '/api/booking/frontend/return-places';
        if (selectorModel.requestLanguage != null) {
            returnPlacesURL += '?lang='+selectorModel.requestLanguage;
        }

        var dataSourceReturnPlaces = new RemoteDataSource(returnPlacesURL,
																													{'id':'id','description':'name'});
        var returnPlace = new SelectSelector('return_place', 
        		dataSourcePickupPlaces, null, false, '',
                function() {
                  if (selectorModel.allowCustomPlaces) {
                      $('#return_place').append($('<option>', {
                          value: 'other',
                          text : '<%=t.front_end_reservation.another_place%>'
                      }));
                  }
                	$('#return_place').selectpicker();
                	$('#return_place').selectpicker('refresh');
                } );

        if (selectorModel.allowCustomPlaces) {
            $('#return_place').bind('change', function() {
                selectorController.returnPlaceChanged();
            });
        }

  	},

  	loadPickupReturnTime: function() {

        var dataSourcePickupReturnTime = new RemoteDataSource('/api/booking/frontend/pickup-return-times',
																						{
        	  																	id: function(data){return data;},
																							description: function(data){return data;}
																						});

        var pickupTime = new SelectSelector('time_from', 
        		dataSourcePickupReturnTime, '10:00', false, '',
                function() { 
                	$('#time_from').selectpicker();
					        $('#time_from').val('10:00');
					        $('#time_from').selectpicker('refresh');
                } );             
        var returnTime = new SelectSelector('time_to', 
        		dataSourcePickupReturnTime, '10:00', false, '',
                function() { 
                	$('#time_to').selectpicker();
					$('#time_to').val('10:00');
					$('#time_to').selectpicker('refresh');                	 
                } );  

  	}

  };

  selectorView.init();

});

</script>
